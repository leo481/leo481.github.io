---
title: CentOS系统启动流程
date: 2018-01-29 21:24:47
tags:
---

# linux系统的启动流程

linux系统的启动流程大致分成以下几个步骤:
POST加电自检-->BIOS(Boot Sequence)-->加载对应引导上的MBR(bootloader)-->主引导设置加载其bootloader-->Kernel初始化-->intrd-->/etc/int进程加载/etc/inittab,流程图如下:
![centos启动流程](https://hexo-1256034174.cos.ap-guangzhou.myqcloud.com/centos%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.jpg)
# 每个流程的详解
## POST开机自检：
电脑主机打开电源的时候，随后会听到滴的一声，系统启动开始了开机自检（POST-power on selftest）自检开始），这个过程中主要是检测计算机硬件设备比如：CPU，内存，主板，显卡，CMOS等设备是否有故障存在，如果有硬件故障的话将按两种情况理：对于严重故障(致命性故障)则停机，此时由于各种初始化操作还没完成，不能给出任何提示或信号；对于非严重故障则给出提示或声音报警信号，等待用户处理），如果没有故障，POST完整自己的接力任务，将尾部工作交接给BIOS处理。
## BIOS：
计算机加电自检完成后第一个读取的地方就是就是BIOS（Basic Input Output System，基础输入输出系统），BIOS里面记录了主机板的芯片集与相关设置，如CPU与接口设备的通信频率、启动设备的搜索顺序、硬盘的大小与类型、系统时间、外部总线、各种接口设备的I/O地址、已经与CPU通信的IRQ中断信息，所以，启动如果要顺利启动，首先要读取BIOS设置。但是如果BIOS找不到任何的引导设备那么启动将会失败.

按照BIOS所设定的系统启动流程，如果检测通过，则根据引导次序(Boot Sequence)开始在第一台设备上支持启动程序，我们的启动设备主要包括硬盘、USB、SD等，我们一般用的是硬盘，然后进行读取第一个设备就是硬盘，第一个要读去的就是该硬盘的主引导记录MBR（Master Boot Record），然后系统可以根据启动区安装的引导加载程序（Boot Loader）开始执行核心识别的工作。【MBR一共是512字节,其中446字节是加载内核文件由它确定选择的操作系统内核】

## Boot Loader 加载Grub程序
在这个过程中主要靠Grub的引导开始的，Grub分为3个阶段：
- stage1：主要是Boot loader,位于MBR中，它的存在是为了引导stage2
- stage 1.5:位于boot分区(基本磁盘分区)，为识别内核文件系统提供文件系统识别扩展
- stage2:也是位于boot分区(基本磁盘分区)，Grub的引导程序

在/boot/grub/下面我们看到了熟悉的stage1，stage2及grub工具的配置文件grub.conf，那么grub.conf内都定义了什么呢?

首先我们先了解一下grub的功能有哪些:
### Grub的功能

*选择要启动的内核或系统*

如果系统有多个内核并存时我们可以通过在系统启动倒计时时我们按任意键进入选择需要用的内核或系统，但是我的系统只有一个操作系统，所以它默认时间一到就进入当前的系统了

当系统启动到跑进度条时我们可以输入e键盘进入**交互式**界面

grub的配置文件
- centos6: /etc/grub.conf
- centos7: /boot/grub2.cfg

因为centos7改用了grub2,以自动生成配置,所以这里以centos6为例
```
[root@localhost ~]# vim grub.conf
# grub.conf generated by anaconda
#
# Note that you do not have to rerun grub after makingchanges to this file
# NOTICE:You havea /boot partition.This means that
#allkernel and initrd paths are relative to /boot/, eg.
#root(hd0,0)
#kernel/vmlinuz-version ro root=/dev/mapper/vg0-root
#initrd/initrd-[generic-]version.img
#boot=/dev/sda
default=0 #→操作系统或内核的标题
timeout=5 #→选择内核文件超时时间
splashimage=(hd0,0)/grub/splash.xpm.gzgrub #→界面下的系统启动背景图片
hiddenmenu #→菜单隐藏
title CentOS (2.6.32-431.el6.x86_64)  #→grub标题
root(hd0,0) #→设定内核文件所在的分区为grub的根,Device表示方式: 在grub中，统统以hd开头，并紧跟一个数字做各磁盘设备的标记，从0开始编号 Part表示方式：代表分区，从0开始编号
kernel/vmlinuz-2.6.32-431.el6.x86_64 ro root=/dev/mapper/vg0-root rhgb quiet #→定义要使用的内核文件，后面可附加传递给内核的启动参数
initrd/initramfs-2.6.32-431.el6.x86_64.img #→指定为内核提供额外驱动等功能的ram disk或ram fs文件,通常为cpio归档，并使用gzip压缩；通常以.img作为文件名后缀
```
## Kernel初始化
根据Grub内的定义，grub读取完毕后就把下面的工作交个内核了。kernel主要是完成系统硬件探测及硬件驱动的初始化，并且以读写的方式挂载根文件系统（根切换），那么这里就出现了一个“先有鸡还是先有蛋的文件了”，具体是什么那？

要想访问真正的根文件系统（rootfs）的话，就必须加载根文件系统中的设备，这时根文件系统又没有挂载，要挂载根文件系统又得加载根文件系统中的驱动程序，哪怎么办呢？为了解决这个问题，这是就用到了initrd文件了。

再来说下kernel初始化所要工作的内容做下简单总结：

探测硬件->加载驱动（initrd)->挂载根文件系统->rootfs(/sbin/init)

内核空间通过一个间接的initrd(微型linux)向用户空间的/sbin/init过渡，所以gurb开始引导内核转向initrd。initrd：一个虚拟的文件系统，里面有lib、bin、sbin、usr、proc、sys、var、dev、boot等一些目录，其实你会发现里面的目录有点像真的/对吧，所以我们称之为虚拟的根文件系统，作用就是将kernel和真的根文件系统建立关联关系，让kernel去initrd中加载根文件系统所需要的驱动程序，并以读写的方式挂载根文件系统，并让执行用户空间当中第一个进程init.

这里要需要做一下说明:**initrd和initramfs的区别，首先initrd是系统加载驱动时将内存模拟为磁盘设备，需要再次在内核中缓存，而initramfs却将内存直接模拟为文件系统，这样它就比起initrd显得更加的优越。所以在Centos5上面的initrd在后来的6上面改成了后者.**
## 执行/sbin/init
init会读取系统内的/etc/inittab文件，来完成系统系统的初始化工作。下面来分析一下inittab这个配置文件内的详细内容.

文件中定义了7个linux系统的运行级别
- 0：关机
- 1：单用户模式(root, 无须登录), single, 维护模式；
- 2: 多用户模式，会启动网络功能，但不会启动NFS；维护模式；
- 3：多用户模式，正常模式；文本界面；
- 4：预留级别；可同3级别；
- 5：多用户模式，正常模式；图形界面；
- 6：重启

一般默认级别是3,5

切换级别使用命令:

    init #

查看级别使用命令:

    runlevel

文件中每一行定义一种action以及与之对应的process
id:runlevel:action:process
- action:
    1. wait: 切换至此级别运行一次；
    2.  respawn：此process终止，就重新启动之；
    3.  initdefault：设定默认运行级别；process省略；
    4.  sysinit：设定系统初始化方式，此处一般为指定/etc/rc.d/rc.sysinit；
    5.  ...

### chkconfig命令
查看服务在所有级别的启动或关闭设定情形：

    chkconfig [--list] [name]

添加：

*SysV的服务脚本放置于/etc/rc.d/init.d (/etc/init.d)*

    chkconfig --add name

删除：

    chkconfig --del name

修改指定的链接类型

    chkconfig [--level levels] name <on|off|reset>
        --level LLLL: 指定要设置的级别；省略时表示2345；

## 执行	/etc/rc.d/rc.sysinit: 系统初始化脚本
1. 设置主机名；
2. 设置欢迎信息；
3. 激活udev和selinux; 
4. 挂载/etc/fstab文件中定义的文件系统；
5. 检测根文件系统，并以读写方式重新挂载根文件系统；
6. 设置系统时钟；
7. 激活swap设备；
8. 根据/etc/sysctl.conf文件设置内核参数；
9. 激活lvm及software raid设备；
10. 加载额外设备的驱动程序；
11. 清理操作；

### 小结
/sbin/init --> (/etc/inittab) --> 设置默认运行级别 --> 运行系统初始脚本、完成系统初始化 --> 关闭对应下需要关闭的服务，启动需要启动服务 --> 设置登录终端 